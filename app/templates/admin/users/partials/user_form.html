<form class="ui form" method="post" action="{{ url_for('user_management') }}" autocomplete="off">
    {{ csrf_token()| safe }}
    {% if user_to_edit %}
        <input type="hidden" name="user_id" value="{{ user_to_edit.id }}">
    {% endif %}

    <div class="field" data-tooltip="Eingabeformat: Vorname Name (z.B. Martin Meier)" data-position="top left">
        <label>Name</label>
        <input type="text" name="name" placeholder="Vorname Name" 
            required
            pattern="^[A-ZÄÖÜ][a-zäöüß]+(?:\s+[A-Za-zÄÖÜäöüß]+)*\s+[A-ZÄÖÜ][a-zäöüß]+$"
            title="Bitte geben Sie den Namen im Format 'Vorname Name' ein. Der erste Buchstabe des ersten und des letzten Wortes muss großgeschrieben sein."
            value="{{ user_to_edit.name if user_to_edit else '' }}">
    </div>
    <div class="field" data-tooltip="Eingabeformat: vorname.nachname (z.B. martin.meier)" data-position="top left">
        <label>Nutzername</label>
        <input name="email" placeholder="vorname.nachname"
                required
                pattern="^[0-9]*[a-zäöüß]+[0-9]*\.[0-9]*[a-zäöüß]+[0-9]*$"
                title="Bitte im Format vorname.nachname eingeben (z.B. martin.meier)."
                value="{{ user_to_edit.email if user_to_edit else '' }}" autocomplete="off"
                hx-get="{{ url_for('validate_username') }}"
                hx-trigger="input changed delay:400ms"
                hx-target="#username-help"
                hx-include="[name='email']"
                hx-params="*">
        <div id="username-help" class="ui tiny message" style="margin-top:.5rem;"></div>
    </div>
    <div class="field">
        <label>Passwort</label>
        <input type="password" name="password" placeholder="Neues Passwort" autocomplete="new-password">
    </div>

    <div class="field">
        <label>Standort</label>
        <select class="ui dropdown" name="location" required>
            <option value="">-- Bitte wählen --</option>
            {% for loc in locations %}
                <option value="{{ loc.location }}"
                    {% if user_to_edit and user_to_edit.location == loc.location %}selected{% endif %}>
                    {{ loc.location }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="field">
        <label>Rolle</label>
        <select class="ui dropdown" name="role">
            <option value="user" {% if user_to_edit and user_to_edit.role == 'user' %}selected{% endif %}>Benutzer</option>

            {% if user.role == 'superadmin' %}
                <option value="admin" {% if user_to_edit and user_to_edit.role == 'admin' %}selected{% endif %}>Administrator</option>
            {% endif %}

            {% if user.role == 'superadmin' %}
                <option value="superadmin" {% if user_to_edit and user_to_edit.role == 'superadmin' %}selected{% endif %}>Superadministrator</option>
            {% endif %}
        </select>
    </div>

    <div class="ui buttons">
        <button id="submitBtn" class="ui primary button" type="submit">
            {% if user_to_edit %}Änderungen speichern{% else %}Benutzer erstellen{% endif %}
        </button>
        {% if user_to_edit %}
            <button class="ui button" type="button" onclick="discardChanges()">Änderungen verwerfen</button>
        {% endif %}
    </div>
    
</form>


<script>
  // Optional: prevent submit when username is taken (HTMX event hook)
  document.body.addEventListener('htmx:afterOnLoad', function (evt) {
    if (evt.detail && evt.detail.requestConfig && evt.detail.requestConfig.path &&
        evt.detail.requestConfig.path.includes("validate-username")) {
      const resp = evt.detail.xhr.responseText || "";
      const taken = resp.includes('data-username-taken="1"');
      document.getElementById('submitBtn').disabled = taken;
    }
  });
</script>