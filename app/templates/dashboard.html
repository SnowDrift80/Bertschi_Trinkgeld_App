<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/bertschi_favicon32.png') }}">
    <title>RP Trinkgelderfassung</title>

    <!-- Fomantic UI CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='fomantic/semantic.min.css') }}">

    <!-- jQuery and JS dependencies -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='fomantic/semantic.js') }}"></script>
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>

    <style>
        body, html {
            height: 100%;
            margin: 0;
        }

        .top-bar {
            height: 2cm;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #ccc;
        }
        .workspace {
            height: calc(100% - 2cm - 1px);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2rem;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    {% include 'partials/topbar.html' %}

    <!-- Main Workspace -->
    <div class="workspace">

        <!-- Standortwahl + Button Box -->
        <div class="ui raised segment" style="min-width: 320px; width: 480px; text-align: center; padding: 2rem;">

            <!-- Standort wählen (always shown) -->
            <form method="POST" action="{{ url_for('select_location') }}" class="ui form" autocomplete="off">
            {{ csrf_token()| safe }}
                <div class="field">
                    <label>Standort wählen</label>
                    <select name="location" class="ui fluid dropdown" onchange="this.form.submit()" required>
                    <!-- This is the forced default -->
                    <option value="" disabled selected>— Standort auswählen —</option>

                    {% for loc in all_locations %}
                        <option value="{{ loc.location }}"
                                {% if selected_location == loc.location %}selected{% endif %}>
                        {{ loc.location }}
                        </option>
                    {% endfor %}
                    </select>
                </div>
            </form>

            <div class="ui divider" style="margin-top: 2rem; margin-bottom: 2rem;"></div>

            <!-- Create or Edit Button -->
            {% if existing_report %}
                <a href="{{ url_for('edit_tip', tiph_id=existing_report.tiph_id) }}"
                   class="ui huge primary button requires-location">
                    Trinkgeldabrechnung editieren
                </a>
            {% else %}
                <a href="{{ url_for('create_tip') }}"
                   class="ui huge green button requires-location" id="createButton">
                    Trinkgeldabrechnung erstellen
                </a>
            {% endif %}
        </div>

        <!-- Last 7 Days Table or Empty Message -->
        <div style="flex: 0 0 auto; margin-top: 3rem; width: 80%;">
            {% if tiph_entries %}
                <div class="ui container">
                    <h3 class="ui dividing header">Trinkgeldabrechnungen der letzten 7 Tage</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 class="ui header" style="margin: 0;">Standort: {{ selected_location or '-' }}</h4>
                        {% if user.role == 'superadmin' %}
                            <a class="ui icon small button" style="margin: 0;" onclick="$('#exportModal').modal('show')">
                                <i class="download icon"></i> Export nach Excel
                            </a>
                        {% endif %}
                    </div>
                    <table class="ui celled table">
                        <thead>
                            <tr>
                                <th style="width: 18%;">Datum</th>
                                <th style="width: 26%;">Erstellt von</th>
                                <th style="width: 26%;">Standort</th>
                                {% if user.role == 'superadmin' %}
                                    <th style="width: 20%; text-align: right;">Trinkgeld (CHF)</th>
                                    <th style="width: 10%;">Aktion</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in tiph_entries %}
                                <tr>
                                    <td style="width: 18%;">{{ entry.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                                    <td style="width: 26%;">{{ entry.username }}</td>
                                    <td style="width: 26%;">{{ entry.location }}</td>
                                    {% if user.role == 'superadmin' %}
                                        <td style="width: 20%; text-align: right;">
                                            {{ "%.2f"|format(tip_totals[entry.tiph_id]) }}
                                        </td>
                                        <td style="width: 10%; white-space: nowrap; text-align: right;">
                                            <a href="{{ url_for('edit_tip', tiph_id=entry.tiph_id) }}"
                                               class="ui icon button blue requires-location" title="Bearbeiten">
                                                <i class="pencil alternate icon"></i>
                                            </a>
                                            <button type="button"
                                                    class="ui icon button red show-header-delete-modal"
                                                    title="Löschen"
                                                    data-delete-url="{{ url_for('delete_tip', tiph_id=entry.tiph_id) }}">
                                                <i class="trash icon"></i>
                                            </button>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="ui text container center aligned" style="text-align: center;">
                    <p>In den letzten 7 Tagen wurden keine Trinkgelderfassungen für diesen Standort erstellt.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal asking user to pick a location first -->
    <div class="ui tiny modal" id="locationRequiredModal">
        <div class="header">Standort erforderlich</div>
        <div class="content">
            <p>Bitte wählen Sie zuerst einen Standort aus, bevor Sie fortfahren.</p>
        </div>
        <div class="actions">
            <div class="ui approve primary button">OK</div>
        </div>
    </div>

    <!-- Delete Confirmation Modal for TipH on dashboard -->
    <div class="ui small modal" id="deleteHeaderModalDashboard">
        <div class="header">Erfassung löschen</div>
        <div class="content">
            <p>Möchten Sie diese Trinkgelderfassung inklusive aller Einträge wirklich löschen?</p>
        </div>
        <div class="actions">
            <form method="POST" id="deleteHeaderFormDashboard" action="">
                {{ csrf_token()| safe }}
                <button type="button" class="ui button deny">Abbrechen</button>
                <button type="submit" class="ui red button">Löschen</button>
            </form>
        </div>
    </div>

    <!-- Export Modal for superadmin -->
    {% if user.role == 'superadmin' %}
        <div class="ui modal" id="exportModal">
            <i class="close icon"></i>
            <div class="header">Export Parameter einstellen</div>
            <div class="content">
                <form class="ui form" id="exportForm" method="POST" action="{{ url_for('export_tip_data') }}">
                    {{ csrf_token()| safe }}
                    <div class="field">
                        <div class="ui toggle checkbox">
                            <input type="checkbox" name="all_locations" id="all_locations">
                            <label for="all_locations">Alle Standorte</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>Standort</label>
                        <select name="location" id="location_dropdown" class="ui fluid dropdown">
                            <option value="">— Standort auswählen —</option>
                            {% for loc in all_locations %}
                                <option value="{{ loc.location }}">{{ loc.location }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="field">
                        <label>Benutzer (optional)</label>
                        <div id="export-user-dropdown" class="ui fluid search selection clearable dropdown">
                            <input type="hidden" name="user_id" value="">
                            <i class="dropdown icon"></i>
                            <input class="search" autocomplete="off" tabindex="0">
                            <div class="default text">Alle Benutzer</div>
                            <div class="menu">
                                {% if other_location_users %}
                                    <div class="header">Alle Standorte</div>
                                    {% for u in other_location_users %}
                                        <div class="item" data-value="{{ u.id }}">{{ u.name }} ({{ u.username }}) — {{ u.location }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="two fields">
                        <div class="field">
                            <label>Datum von</label>
                            <input type="date" name="date_from" required>
                        </div>
                        <div class="field">
                            <label>Datum bis</label>
                            <input type="date" name="date_to" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="actions" style="display: flex; justify-content: space-between;">
                <button class="ui button" onclick="$('#exportModal').modal('hide')">Abbrechen</button>
                <button class="ui primary button" onclick="document.getElementById('exportForm').submit()">Ausführen</button>
            </div>
        </div>
    {% endif %}

    <script>
        // -------- Fomantic init (once) --------
        $('.ui.dropdown').dropdown();
        $('.ui.checkbox').checkbox();

        // -------- Delete modal (dashboard) --------
        document.querySelectorAll('.show-header-delete-modal').forEach(btn => {
            btn.addEventListener('click', function () {
                const url = this.getAttribute('data-delete-url');
                const form = document.getElementById('deleteHeaderFormDashboard');
                form.action = url;
                $('#deleteHeaderModalDashboard').modal('show');
            });
        });

        // -------- Standort-required guard --------
        function currentLocationValue() {
            return $('select[name="location"]').val();
        }

        // Block actions that require a Standort
        $(document).on('click', 'a.requires-location, button.requires-location', function (e) {
            if (!currentLocationValue()) {
                e.preventDefault();
                $('#locationRequiredModal').modal('show');
                return false;
            }
        });

        // Visual disable for "Erstellen" button
        $(function () {
            const $dropdown = $('select[name="location"]');
            const $createButton = $('#createButton');
            function updateButtonState() {
                const hasSelection = !!$dropdown.val();
                $createButton.toggleClass('disabled', !hasSelection);
            }
            updateButtonState();            // on page load
            $dropdown.on('change', updateButtonState);
        });

        // -------- Export modal logic (superadmin) --------
        {% if user.role == 'superadmin' %}
        function rebuildUserDropdown(users, headerText) {
            const $dd = $('#export-user-dropdown');
            const $menu = $dd.find('.menu');
            $menu.empty();

            if (headerText) $menu.append(`<div class="header">${headerText}</div>`);

            if (!users.length) {
                $menu.append('<div class="item disabled">Keine Benutzer gefunden</div>');
            } else {
                users.forEach(u => {
                    const label = `${u.name} (${u.username}) — ${u.location}`;
                    $menu.append(`<div class="item" data-value="${u.id}">${label}</div>`);
                });
            }

            $dd.dropdown('clear').dropdown('refresh');
        }

        async function refreshUsersForExport() {
            const allChecked = $('#all_locations').is(':checked');
            const loc = $('#location_dropdown').val() || '';
            const params = new URLSearchParams();
            params.set('all', allChecked ? '1' : '0');
            if (!allChecked && loc) params.set('location', loc);

            try {
                const resp = await fetch(`/api/users-for-export?${params.toString()}`, { credentials: 'same-origin' });
                const users = await resp.json();
                const header = allChecked ? 'Alle Standorte' : (loc ? `Standort: ${loc}` : 'Benutzer');
                rebuildUserDropdown(users, header);
            } catch (e) {
                rebuildUserDropdown([], 'Fehler beim Laden');
                console.error(e);
            }
        }

        $('#all_locations').on('change', function () {
            const checked = $(this).is(':checked');
            if (checked) $('#location_dropdown').val('').dropdown('clear');
            refreshUsersForExport();
        });

        $('#location_dropdown').on('change', function () {
            const val = $(this).val();
            if (val) $('#all_locations').prop('checked', false).closest('.ui.checkbox').checkbox('set unchecked');
            refreshUsersForExport();
        });

        $('#exportModal').modal({
            onShow: function () {
                $('#all_locations').prop('checked', true).closest('.ui.checkbox').checkbox('set checked');
                $('#location_dropdown').val('').dropdown('clear');

                $('#export-user-dropdown').dropdown({
                    clearable: true,
                    fullTextSearch: 'exact',
                    forceSelection: false,
                    selectOnKeydown: false
                });

                refreshUsersForExport();
            }
        });
        {% endif %}
    </script>
</body>
</html>
