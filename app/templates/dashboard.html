<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/bertschi_favicon32.png') }}">
    <title>RP Trinkgelderfassung</title>

    <!-- Fomantic UI CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='fomantic/semantic.min.css') }}">

    <!-- jQuery and JS dependencies -->
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='fomantic/semantic.js') }}"></script>
    <script src="{{ url_for('static', filename='js/htmx.min.js') }}"></script>

    <style>
        body, html {
            height: 100%;
            margin: 0;
        }

        .top-bar {
            height: 2cm;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            background-color: #f9fafb;
            border-bottom: 1px solid #ccc;
        }
        .workspace {
            height: calc(100% - 2cm - 1px);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2rem;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    {% include 'partials/topbar.html' %}

    <!-- Main Workspace -->
    <div class="workspace">

        <!-- Standortwahl + Button Box -->
        <div class="ui raised segment" style="min-width: 320px; width: 480px; text-align: center; padding: 2rem;">

            <!-- Standort wählen (always shown) -->
            <form method="POST" action="{{ url_for('select_location') }}" class="ui form" autocomplete="off">
            {{ csrf_token()| safe }}
                <div class="field">
                    <label>Standort wählen</label>
                    <select name="location" class="ui fluid dropdown" onchange="this.form.submit()" required>
                    <option value="" disabled selected>— Standort auswählen —</option>

                    {# use the new dedicated list here #}
                    {% for loc in dropdown_locations %}
                        <option value="{{ loc.location }}"
                                {% if selected_location == loc.location %}selected{% endif %}>
                        {{ loc.location }}
                        {% if todays_owner_by_location.get(loc.location) %}
                            — {{ todays_owner_by_location.get(loc.location) }}
                        {% endif %}
                        </option>
                    {% endfor %}
                    </select>
                </div>
            </form>

            <div class="ui divider" style="margin-top: 2rem; margin-bottom: 2rem;"></div>

            <!-- Create or Edit Button -->
            {% if not existing_report %}
                {% if has_user_report_today %}
                    <div class="ui message warning">
                        Sie haben heute bereits eine Abrechnung<br>(Standort: {{ user_report_today.location }})
                    </div>
                    <a href="{{ url_for('edit_tip', tiph_id=user_report_today.tiph_id) }}"
                    class="ui huge primary button requires-location">
                    Eigene Abrechnung öffnen
                    </a>
                {% else %}
                    <a href="{{ url_for('create_tip') }}"
                    class="ui huge green button requires-location" id="createButton">
                    Trinkgeldabrechnung erstellen
                    </a>
                {% endif %}
                {% elif report_owned_by_current_user %}
                <a href="{{ url_for('edit_tip', tiph_id=existing_report.tiph_id) }}"
                    class="ui huge primary button requires-location">
                    Trinkgeldabrechnung editieren
                </a>
                {% else %}
                {% if has_user_report_today %}
                    <div class="ui message warning">
                        Sie haben heute bereits eine Abrechnung<br>(Standort: {{ user_report_today.location }})
                    </div>
                    <div class="ui" style="display:flex; justify-content:center; width:100%;">
                        <div class="column right aligned">
                            <a href="{{ url_for('edit_tip', tiph_id=user_report_today.tiph_id) }}"
                                class="ui huge primary button">
                                Eigene Abrechnung öffnen
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div style="width:100%; text-align:center;">
                        <form id="takeoverForm"
                                method="POST"
                                action="{{ url_for('takeover_and_edit_tiph', tiph_id=existing_report.tiph_id) }}"
                                style="display:inline-block; margin:0;">
                            {{ csrf_token()|safe }}
                            <button type="button"
                                    class="ui huge orange button show-takeover-confirm requires-location">
                            Übernehmen &amp; editieren
                            </button>
                        </form>
                    </div>
                {% endif %}
            {% endif %}

        </div>

        <!-- Last 7 Days Table or Empty Message -->
        <div style="flex: 0 0 auto; margin-top: 3rem; width: 80%;">
            {% if tiph_entries %}
                <div class="ui container">
                    <h3 class="ui dividing header">Trinkgeldabrechnungen der letzten 7 Tage</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 class="ui header" style="margin: 0;">Standort: {{ selected_location or '-' }}</h4>
                        {% if user.role == 'superadmin' %}
                            <a class="ui icon small button" style="margin: 0;" onclick="$('#exportModal').modal('show')">
                                <i class="download icon"></i> Export nach Excel
                            </a>
                        {% endif %}
                    </div>
                    <table class="ui celled table">
                        <thead>
                            <tr>
                                <th style="width: 18%;">Datum</th>
                                <th style="width: 26%;">Erstellt von</th>
                                <th style="width: 26%;">Standort</th>
                                {% if user.role == 'superadmin' %}
                                    <th style="width: 20%; text-align: right;">Trinkgeld (CHF)</th>
                                    <th style="width: 10%;">Aktion</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in tiph_entries %}
                                <tr>
                                    <td style="width: 18%;">{{ entry.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
                                    <td style="width: 26%;">{{ entry.username }}</td>
                                    <td style="width: 26%;">{{ entry.location }}</td>
                                    {% if user.role == 'superadmin' %}
                                        <td style="width: 20%; text-align: right;">
                                            {{ "%.2f"|format(tip_totals[entry.tiph_id]) }}
                                        </td>
                                        <td style="width: 10%; white-space: nowrap; text-align: right;">
                                            <a href="{{ url_for('edit_tip', tiph_id=entry.tiph_id) }}"
                                               class="ui icon button blue" title="Bearbeiten">
                                                <i class="pencil alternate icon"></i>
                                            </a>
                                            <button type="button"
                                                    class="ui icon button red show-header-delete-modal"
                                                    title="Löschen"
                                                    data-delete-url="{{ url_for('delete_tip', tiph_id=entry.tiph_id) }}">
                                                <i class="trash icon"></i>
                                            </button>
                                        </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="ui text container center aligned" style="text-align: center;">
                    <p>In den letzten 7 Tagen wurden keine Trinkgelderfassungen für diesen Standort erstellt.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Modal asking user to pick a location first -->
    <div class="ui tiny modal" id="locationRequiredModal">
        <div class="header">Standort erforderlich</div>
        <div class="content">
            <p>Bitte wählen Sie zuerst einen Standort aus, bevor Sie fortfahren.</p>
        </div>
        <div class="actions">
            <div class="ui approve primary button">OK</div>
        </div>
    </div>

    <!-- Delete Confirmation Modal for TipH on dashboard -->
    <div class="ui small modal" id="deleteHeaderModalDashboard">
        <div class="header">Erfassung löschen</div>
        <div class="content">
            <p>Möchten Sie diese Trinkgelderfassung inklusive aller Einträge wirklich löschen?</p>
        </div>
        <div class="actions">
            <form method="POST" id="deleteHeaderFormDashboard" action="">
                {{ csrf_token()| safe }}
                <button type="button" class="ui button deny">Abbrechen</button>
                <button type="submit" class="ui red button">Löschen</button>
            </form>
        </div>
    </div>


    <!-- Takeover Confirmation Modal -->
    <div class="ui small modal" id="takeoverConfirmModal">
        <div class="header">Übernahme bestätigen</div>
        <div class="content">
            Sind Sie sicher, dass Sie die Abrechnung von <strong>{{ report_owner_name }}</strong> übernehmen wollen?
        </div>
        <div class="actions">
        <button type="button" class="ui cancel primary button" id="takeoverCancel" autofocus>Nein</button>
        <button type="button" class="ui approve button">Ja</button>
        </div>
    </div>


    <!-- Export Modal for superadmin -->
    {% if user.role == 'superadmin' %}
        <div class="ui modal" id="exportModal">
            <i class="close icon"></i>
            <div class="header">Export Parameter einstellen</div>
            <div class="content">
                <form class="ui form" id="exportForm" method="POST" action="{{ url_for('export_tip_data') }}">
                    {{ csrf_token()| safe }}
                    <div class="field">
                        <div class="ui toggle checkbox">
                            <input type="checkbox" name="all_locations" id="all_locations">
                            <label for="all_locations">Alle Standorte</label>
                        </div>
                    </div>

                    <div class="field">
                        <label>Standort</label>
                        <select name="location" id="location_dropdown" class="ui fluid dropdown">
                            <option value="">— Standort auswählen —</option>
                            {% for loc in all_locations_full %}
                                <option value="{{ loc.location }}">{{ loc.location }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="field">
                        <label>Benutzer (optional)</label>
                        <div id="export-user-dropdown" class="ui fluid search selection clearable dropdown">
                            <input type="hidden" name="user_id" value="">
                            <i class="dropdown icon"></i>
                            <input class="search" autocomplete="off" tabindex="0">
                            <div class="default text">Alle Benutzer</div>
                            <div class="menu">
                                {% if other_location_users %}
                                    <div class="header">Alle Standorte</div>
                                    {% for u in other_location_users %}
                                        <div class="item" data-value="{{ u.id }}">{{ u.name }} ({{ u.username }}) — {{ u.location }}</div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="two fields">
                        <div class="field">
                            <label>Datum von</label>
                            <input type="date" name="date_from">
                        </div>
                        <div class="field">
                            <label>Datum bis</label>
                            <input type="date" name="date_to">
                        </div>
                    </div>
                </form>

                <div class="field">
                    <div class="ui tiny buttons" id="export-date-presets" style="display:inline-flex; width:100%; justify-content:center;">
                        <button type="button" class="ui button" data-preset="today">Heute</button>
                        <button type="button" class="ui button" data-preset="last-week">Letzte Woche</button>
                        <button type="button" class="ui button" data-preset="mtd">Monat bis heute</button>
                        <button type="button" class="ui button" data-preset="last-month">Letzter Monat</button>
                        <button type="button" class="ui button" data-preset="last-quarter">Letztes Quartal</button>
                        <button type="button" class="ui button" data-preset="ytd">Jahr bis heute</button>
                    </div>
                </div>                
            </div>

            <div class="actions" style="display: flex; justify-content: space-between;">
                <button class="ui button" onclick="$('#exportModal').modal('hide')">Abbrechen</button>
                <button class="ui primary button" onclick="document.getElementById('exportForm').submit()">Ausführen</button>
            </div>
        </div>
    {% endif %}

    
    <script>
        $(function () {
            const $modal = $('#takeoverConfirmModal');
            $('.show-takeover-confirm').on('click', function (e) {
            e.preventDefault();
            $modal.modal({
                closable: false,
                autofocus: false,
                onApprove: function () {
                document.getElementById('takeoverForm').submit();
                }
            }).modal('show');
            });
        });
    </script>

    <script>
        window.IS_SUPERADMIN = {{ 'true' if user.role == 'superadmin' else 'false' }};
    </script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ range(1,999999)|random }}"></script>
</body>
</html>
